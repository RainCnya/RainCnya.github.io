---
title: 差分约束系统 (Difference_Constraints)
tags:
  - 图论/最短路
  - 图论/最短路/差分约束
categories:
  - 211_Patchouli
  - 02_图论
  - 01_最短路及其应用
abbrlink: 6cae5d5b
date: 2025-12-16 15:20:00
updated: 2025-12-24 19:05:00
---
# 差分约束系统 (Difference Constraints)

## 1. 生态位

- **定义**: 差分约束系统是将代数中的不等式组 $X_u - X_v \le w$ 映射为图论中的边约束，利用最短路算法的松弛性质来寻找一组可行解。它实现了代数约束向拓扑路径的转化，是处理线性不等式组一致性判定的核心工具。
    
- **解决痛点**: 解决了多个变量相互制约下的取值问题，能高效判定约束冲突（负环判定）并给出极端情况下的可行解。
    

## 2. 逻辑支点

- **核心不变量**: 三角不等式 $dist[v] \le dist[u] + w$。最短路在达到稳态时，所有的边都必然满足该性质，这与不等式 $X_v \le X_u + w$ 完美对偶。
    
- **判定准则**: 若图中存在负环，则说明不等式组存在逻辑闭环冲突（如 $A < B < C < A$），系统**无解**。
    
- **渗透点 (Penetration)**: 想象每一个变量是一个高度，每一个不等式是一根限制长度的绳子。如果绳子太短无法连接所有点并满足拓扑关系，就会产生负环。
    

## 3. 实战部署

{% fold info @Code: Difference Constraints (SPFA) %}

```cpp
bool spfa( int n )
{
    for( int i = 1; i <= n; ++ i )
    {
        dist[ i ] = 0; // 求可行解通常初始为 0 以覆盖所有联通块
        vis[ i ] = 1;
        cnt[ i ] = 0;
        q.push( i );
    }

    while( !q.empty( ) )
    {
        int u = q.front( );
        q.pop( );
        vis[ u ] = 0;

        for( auto &e : adj[ u ] )
        {
            if( dist[ u ] + e.w < dist[ e.v ] )
            {
                dist[ e.v ] = dist[ u ] + e.w;
                cnt[ e.v ] = cnt[ u ] + 1;
                if( cnt[ e.v ] > n )
                {
                    return false; // 存在负环，无解
                }

                if( !vis[ e.v ] )
                {
                    q.push( e.v );
                    vis[ e.v ] = 1;
                }
            }
        }
    }
    return true;
}
```

{% endfold %}

## 4. 知识粘附

- **变体模型**:
    
    - **最大/最小可行解**: 初始值 `inf` 对应限制下的最大解；初始 `0` 配合超级源点对应相对最小解。
        
    - **前缀和转化**: 将区间和问题 $[L, R] \le K$ 转化为 $S[R] - S[L-1] \le K$ 的标准差分形式。
        
- **母题索引**:
    
    - [P5960 [【模板】差分约束算法]](https://www.luogu.com.cn/problem/P5960 "null") —— 基础一致性判定。
        
    - [P1993 小K的农场 (Difference_Constraints)](P1993%20小K的农场%20(Difference_Constraints).md) —— 实际问题的差分建模转换。