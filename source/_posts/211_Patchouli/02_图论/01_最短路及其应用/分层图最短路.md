---
title: 分层图最短路 (Layered_Graph)
tags:
  - 图论/最短路
  - 算法/状态压缩
categories:
  - 211_Patchouli
  - 02_图论
  - 01_最短路及其应用
abbrlink: 2a513a9f
date: 2025-12-16 15:10:00
updated: 2025-12-24 19:05:05
---
# 分层图最短路 (Layered Graph)

## 1. 生态位

- **定义**: 通过增加状态维度将原图扩展为多层平行空间，利用层间单向边描述不可逆的状态跳变，实现状态空间的“物理拉伸”与全局最短路搜索。它解决了带有全局限制的路径优化问题，将 $O(N^2)$ 的动态规划隐式化为图论搜索。
    

## 2. 逻辑支点

- **核心不变量**: 状态维度分量。第 $k$ 层节点 $u$ 表示：当前已消耗 $k$ 次机会且处于物理位置 $u$。
    
- **状态转移/数学推导**: 若边 $u \to v$ 权值为 $w$，且可消耗机会使权值变为 $w'$：
    
    $$dist[v][k] = \min(dist[v][k], dist[u][k] + w)$$$$dist[v][k+1] = \min(dist[v][k+1], dist[u][k] + w')$$
- **渗透点 (Penetration)**: 想象一座大楼，每一层都是完整的地图。走普通道路在同层移动，消耗机会则跨层跳变。答案通常是所有层中终点状态的最小值。
    

## 3. 实战部署

{% fold info @Code: Layered Dijkstra Template %}

```cpp
// 假设 K 次免费机会，点数为 N
// id(u, k) = u + k * n
void build( )
{
    for( auto &e : edges )
    {
        for( int k = 0; k <= K; ++ k )
        {
            // 1. 同层连边 (常规移动)
            add_edge( e.u + k * n, e.v + k * n, e.w );
            
            // 2. 跨层连边 (消耗机会)
            if( k < K )
            {
                add_edge( e.u + k * n, e.v + ( k + 1 ) * n, 0 );
            }
        }
    }
}

// 最终答案：min( dist[target + k * n] ) for k in [0, K]
```

{% endfold %}

## 4. 知识粘附

- **变体模型**:
    
    - **倍增分层图**: 每次跳跃代价翻倍或减半。
        
    - **双向开关图**: 状态可在层间往返。
        
- **母题索引**:
    
    - [P4568 [JLOI2011] 飞行路线](https://www.luogu.com.cn/problem/P4568 "null") —— 标准 $K$ 次免费建模。
        
    - [P4822 [BJWC2012] 冻结](https://www.luogu.com.cn/problem/P4822) —— $K$ 次边权减半（半价）变体。
        
    - [P2939 [USACO09FEB] Revamping Trails G](https://www.luogu.com.cn/problem/P2939) —— 分层图经典练习。